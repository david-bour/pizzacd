name: Continuous Delivery

on: push

env:
    POSTGRES_HOST: ${{ secrets.POSTGRES_HOST }}
    POSTGRES_PORT: ${{ secrets.POSTGRES_PORT }}
    POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
    POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
    POSTGRES_DB: ${{ secrets.POSTGRES_DB }}

jobs:
    build:
        name: Continuous Delivery
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v2

            - name: Build Appserver & Push
              uses: docker/build-push-action@v1
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}
                repository: davidbour/appserver
                tags: latest
                path: ./appserver
                dockerfile: ./appserver/Dockerfile.prod

            - name: Build Nginx & Push
              uses: docker/build-push-action@v1
              with:
                username: ${{ secrets.DOCKER_USERNAME }}
                password: ${{ secrets.DOCKER_PASSWORD }}
                repository: davidbour/nginx
                tags: latest
                path: ./proxy
                dockerfile: ./proxy/Dockerfile

            - name: Try SSH
              uses: appleboy/ssh-action@master
              with:
                host: 165.227.26.118
                username: deployer
                passphrase: ${{ secrets.DO_SSH_KEY_PASSWORD }}
                key: ${{ secrets.DO_SSH_KEY }}
                port: 22
                script: |
                    docker-compose -f docker-compose.prod.yml up -d
